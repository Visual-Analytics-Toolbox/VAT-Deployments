grafana:
  replicas: 1
  resources:
    limits:
      cpu: "1"
      memory: "1Gi"
    requests:
      cpu: 100m
      memory: 128Mi
  ingress:
    enabled: true
    ingressClassName: "nginx"
    hosts:
      - "grafana.berlin-united.com"
    tls:
      - secretName: tls-cert-grafana
        hosts:
          - "grafana.berlin-united.com"
  persistence: 
    enabled: true
    type: "pvc"

  initChownData:
    enabled: false

  plugins:
  - yesoreyeram-infinity-datasource

  datasources:
     datasources.yaml:
      apiVersion: 1
      datasources:
      - name: Prometheus
        type: prometheus
        url: http://monitoring-kube-prometheus-prometheus.monitoring.svc.cluster.local:9090
        access: proxy
        basicAuth: true
        isDefault: true
      - name: Loki
        type: loki
        url: http://monitoring-loki.monitoring.svc.cluster.local:3100
        access: proxy

  dashboardProviders:
   dashboardproviders.yaml:
     apiVersion: 1
     providers:
     - name: 'default'
       orgId: 1
       folder: ''
       type: file
       disableDeletion: false
       editable: true
       options:
         path: /var/lib/grafana/dashboards/default
   
  dashboardsConfigMaps:
    default: "grafana-dashboards"

  assertNoLeakedSecrets: false
  grafana.ini:
    feature_toggles:
      provisioning: true
      kubernetesDashboards: true
    server:
      root_url: https://grafana.berlin-united.com/
    auth:
      disable_login_form: false
      oauth_allow_insecure_email_lookup: true
    auth.generic_oauth:
      verbose_logging: true
      enabled: true
      name: Keycloak
      allow_sign_up: true
      client_id: berlin-united
      client_secret: NyM1HIqX0FZT1AkHASvCGrzEQbIG0ldm
      scopes: openid email profile offline_access roles
      # auth_url must be accessible from the user's browser
      auth_url: https://keycloak.berlin-united.com/auth/realms/berlin-united/protocol/openid-connect/auth
      # token_url and api_url are server-to-server communications
      token_url: https://keycloak.berlin-united.com/auth/realms/berlin-united/protocol/openid-connect/token
      api_url: https://keycloak.berlin-united.com/auth/realms/berlin-united/protocol/openid-connect/userinfo
      role_attribute_path: contains(realm_access.roles[*], 'admin') && 'Admin' || contains(realm_access.roles[*], 'editor') && 'Editor' || 'Viewer'
      login_attribute_path: preferred_username
      auto_assign_org_role: Admin
      name_attribute_path: name
      email_attribute_path: email
      skip_org_role_sync: false
      allow_assign_grafana_admin: true
kube-prometheus-stack:
  # all values are in https://github.com/prometheus-community/helm-charts/blob/main/charts/kube-prometheus-stack/values.yaml
  crds:
    enabled: true

  grafana:
    # we use upstream grafana helm chart, not the one from kube-prometheus-stack
    enabled: false

  kubeProxy:
    enabled: false
  
  prometheusOperator:
    affinity: {}

  prometheus:
    enabled: true

    service:
      enabled: true
      targetPort: 9090

    ingress:
      enabled: true
      ingressClassName: "nginx"
      annotations:
        nginx.ingress.kubernetes.io/auth-type: basic
        nginx.ingress.kubernetes.io/auth-secret: prom-secret
        nginx.ingress.kubernetes.io/auth-realm: 'Authentication Required - admin'
      hosts:
      - "prometheus.berlin-united.com"
      tls:
        - secretName: tls-cert-prometheus
          hosts:
            - "prometheus.berlin-united.com"
    prometheusSpec:
      podMonitorSelectorNilUsesHelmValues: false
      podMonitorSelector: {}
loki:
  loki:
    auth_enabled: false
    commonConfig:
      replication_factor: 1
    schemaConfig:
      configs:
        - from: 2024-04-01
          store: tsdb
          object_store: s3
          schema: v13
          index:
            prefix: loki_index_
            period: 24h
    ingester:
      chunk_encoding: snappy
    tracing:
      enabled: true
    querier:
      # Default is 4, if you have enough memory and CPU you can increase, reduce if OOMing
      max_concurrent: 2
  deploymentMode: SingleBinary
  singleBinary:
    replicas: 1
    resources:
      limits:
        cpu: 3
        memory: 4Gi
      requests:
        cpu: 2
        memory: 2Gi
    extraEnv:
      # Keep a little bit lower than memory limits
      - name: GOMEMLIMIT
        value: 3750MiB

  chunksCache:
    # default is 500MB, with limited memory keep this smaller
    writebackSizeLimit: 10MB

  # Enable minio for storage
  minio:
    enabled: true

  # Zero out replica counts of other deployment modes
  backend:
    replicas: 0
  read:
    replicas: 0
  write:
    replicas: 0

  ingester:
    replicas: 0
  querier:
    replicas: 0
  queryFrontend:
    replicas: 0
  queryScheduler:
    replicas: 0
  distributor:
    replicas: 0
  compactor:
    replicas: 0
  indexGateway:
    replicas: 0
  bloomCompactor:
    replicas: 0
  bloomGateway:
    replicas: 0

promtail:
  initContainer:
  - name: init
    image: docker.io/busybox:1.37
    imagePullPolicy: IfNotPresent
    command:
      - sh
      - -c
      - sysctl -w fs.inotify.max_user_instances=512
    securityContext:
      privileged: true

  podSecurityContext:
    runAsUser: 0
    runAsGroup: 0
  config:
    clients:
      - url: http://monitoring-loki-gateway.monitoring.svc.cluster.local/loki/api/v1/push
